# bl02b1_tif_compressor

SPring-8 BL02B1 ビームライン向け TIFF 画像圧縮・解凍プログラム

## 概要

このプロジェクトは、SPring-8 の BL02B1 ビームラインで生成される大量の TIFF 画像ファイルをリアルタイムで圧縮・解凍するためのツールです。ビルドすると 2 つの実行ファイルが生成されます：

- **bl02b1_tif_compressor.exe**: ディレクトリを監視し、TIFF ファイルを LZ4 形式で圧縮
- **bl02b1_tif_decompressor.exe**: LZ4 圧縮されたアーカイブファイルを解凍・復元

## 主な特徴

### 圧縮機能（bl02b1_tif_compressor）

- **リアルタイム監視**: 指定ディレクトリを監視し、ファイルが生成されると自動的に圧縮
- **高速 LZ4 圧縮**: 高速な圧縮アルゴリズムで大量のファイルを効率的に処理
- **メタデータ保持**: ファイル名、サイズ、形式などのメタデータを含めて圧縮
- **並列処理アーキテクチャ**:
  - **3 つの処理フロー**が独立して並列動作
    1. ディレクトリ監視・読み取り
    2. ファイル圧縮
    3. 元ファイルの削除
  - ディスク I/O の競合を避けるため、読み取りと削除は直列処理
  - 監視と圧縮は並列化により高速化
- **バッチ処理**: 100 ファイル単位でセットとしてまとめて圧縮
- **メモリマップドインデックス**: 効率的なファイル管理
- **完全復元可能**: 解凍時に元のファイルを完全に復元

### 解凍機能（bl02b1_tif_decompressor）

- **高速並列解凍**: 複数の LZ4 アーカイブを並列処理
- **2 つの動作モード**:
  - モード 0: 圧縮された TIFF ファイルをそのまま解凍・出力
  - モード 1: 複数の TIFF ファイルをマージして出力
- **メタデータ復元**: 元のファイル名や属性を完全に復元
- **libtiff 統合**: TIFF ファイルの処理に libtiff ライブラリを使用
- **FINF 変換機能**: 実験データの FINF ファイルをテキスト形式に変換

## 技術仕様

### 並列処理アーキテクチャ

圧縮処理は以下の 3 つのフローで構成されます：

```
[監視スレッド] → [ファイルセット検出] → [圧縮スレッド] → [削除キュー]
     ↓                                         ↓               ↓
[ファイル走査]                          [LZ4圧縮]      [元ファイル削除]
  (並列)                                  (並列)          (直列)
```

- **ディレクトリ監視**: メモリマップドインデックスを使用して高速にファイルを追跡
- **圧縮処理**: 複数スレッド（最大 8 スレッド）でファイルを並列読み込み・圧縮
- **削除処理**: ディスク I/O の競合を避けるため、FastDeleteQueue で順次削除

### LZ4 アーカイブ形式

カスタムアーカイブ形式を使用：

```
[ヘッダー]
- マジックナンバー: "LZ4A" (0x41345A4C)
- バージョン: 1
- ファイル数

[各ファイルのメタデータ]
- ファイル名長、ファイル名
- 拡張子長、拡張子
- 元のサイズ、圧縮サイズ

[圧縮データ]
- 各ファイルのLZ4圧縮データ
```

### 依存ライブラリ

- **LZ4**: 高速圧縮ライブラリ（lz4/lib/）
- **Snappy**: 代替圧縮ライブラリ（snappy/）
- **libtiff**: TIFF 画像処理ライブラリ（tiff/）
- **C++17**: 標準ライブラリの並列処理機能を使用

## ビルド方法

### 前提条件

- CMake 3.10 以上
- C++17 対応コンパイラ
  - Windows: MinGW-w64（推奨）または MSVC
  - Linux/macOS: GCC 7 以上 または Clang

### ビルド手順

```bash
# リポジトリのクローン
git clone <repository-url>
cd bl02b1_tif_compressor

# ビルドディレクトリの作成
mkdir build
cd build

# CMakeの設定
cmake ..

# ビルド実行
cmake --build .
```

Windows の場合、MinGW を使用すると完全静的リンクされた実行ファイルが生成されます。

### 生成される実行ファイル

- `build/bl02b1_tif_compressor.exe` (または `bl02b1_tif_compressor`)
- `build/bl02b1_tif_decompressor.exe` (または `bl02b1_tif_decompressor`)

## 使用方法

### 圧縮プログラム（bl02b1_tif_compressor）

プログラムを実行すると、対話形式で設定を入力します：

```bash
./bl02b1_tif_compressor
```

入力項目：

- **監視ディレクトリ**: TIFF ファイルが生成されるディレクトリ
- **出力ディレクトリ**: LZ4 アーカイブファイルの出力先
- **ファイル名プレフィックス**: 処理対象ファイルの接頭辞
- **セットサイズ**: 1 つのアーカイブにまとめるファイル数（デフォルト: 100）

#### 動作パラメータ

プログラム内で以下の設定が固定されています：

- 最大スレッド数: 8
- LZ4 高速化パラメータ: 4（1=標準、高いほど高速だが圧縮率低下）
- ポーリング間隔: 1 秒
- 処理後の削除: 有効

#### ファイル名規則

プログラムは以下のパターンでファイルを検出します：

```
<prefix>_<run番号:2桁>_<ファイル番号:5桁>.tif
例: 250206_40keV_FeGe_002_ufs_100K_01_00001.tif
```

100 ファイルごとに 1 つの LZ4 アーカイブにまとめられます：

```
<prefix>_<run番号>_<開始番号>.lz4
例: 250206_40keV_FeGe_002_ufs_100K_01_00001.lz4 (1〜100番のファイル)
    250206_40keV_FeGe_002_ufs_100K_01_00101.lz4 (101〜200番のファイル)
```

### 解凍プログラム（bl02b1_tif_decompressor）

プログラムを実行すると、対話形式で設定を入力します：

```bash
./bl02b1_tif_decompressor
```

入力項目：

- **入力ディレクトリ**: LZ4 アーカイブファイルのディレクトリ
- **出力ディレクトリ**: 解凍した TIFF ファイルの出力先
- **プレフィックス**: 処理対象ファイルの接頭辞
- **開始 run 番号**: 処理開始の run 番号
- **終了 run 番号**: 処理終了の run 番号
- **開始画像番号**: 処理開始の画像番号
- **終了画像番号**: 処理終了の画像番号
- **実行タイプ**:
  - 0: TIFF ファイルをそのまま解凍
  - 1: TIFF ファイルをマージして出力
- **マージフレーム数**（実行タイプ 1 の場合のみ）: マージする画像枚数

#### FINF ファイル変換

解凍処理後、実験データの FINF ファイルをテキスト形式に変換するオプションがあります。プロンプトで `y` を入力すると変換が実行されます。

## プロジェクト構造

```
bl02b1_tif_compressor/
├── CMakeLists.txt              # CMakeビルド設定
├── compress.cpp                # 圧縮プログラムのエントリポイント
├── decompress.cpp              # 解凍プログラムのエントリポイント
├── src/
│   ├── common/                 # 共通ユーティリティ
│   │   ├── common.hpp          # ログ、タイムスタンプ等
│   │   └── common.cpp
│   ├── compress/               # 圧縮関連モジュール
│   │   ├── directory_monitor.hpp/cpp    # ディレクトリ監視
│   │   ├── file_set.hpp/cpp             # ファイルセット管理
│   │   ├── file_processor.hpp/cpp       # ファイル処理
│   │   ├── file_index.hpp/cpp           # メモリマップドインデックス
│   │   ├── compress_to_lz4.hpp/cpp      # LZ4圧縮
│   │   ├── compress_to_snappy.hpp/cpp   # Snappy圧縮（代替）
│   │   └── fast_delete_queue.hpp/cpp    # 高速削除キュー
│   └── decompress/             # 解凍関連モジュール
│       ├── lz4_decompressor.hpp/cpp     # LZ4解凍
│       ├── tiff_processor.hpp/cpp       # TIFF処理
│       └── rename_finf.h/cpp            # FINF変換
├── lz4/                        # LZ4ライブラリ（サブモジュール）
├── snappy/                     # Snappyライブラリ（サブモジュール）
├── tiff/                       # libtiffライブラリ（サブモジュール）
└── output/                     # デフォルト出力ディレクトリ
```

## パフォーマンス

- **圧縮速度**: LZ4 の高速化パラメータ 4 で、圧縮速度を優先（標準の 4 倍程度）
- **並列処理**: 最大 8 スレッドでファイル読み込みと圧縮を並列化
- **メモリ効率**: メモリマップドファイルインデックスで効率的なファイル管理
- **削除処理**: FastDeleteQueue で非ブロッキングな削除処理

## 開発情報

### バージョン

- **Version**: 0.2.0
- **Date**: 2025-11-08

### 作成者

- **Author**: Shungo AOYAGI
- **Contact**: aoyagi-shungo011[at]g.ecc.u-tokyo.ac.jp

### ライセンス

依存ライブラリのライセンスに従います：

- LZ4: BSD 2-Clause License
- Snappy: BSD 3-Clause License
- libtiff: BSD-like License

## トラブルシューティング

### ビルドエラー

- C++17 のサポートを確認してください
- CMake のバージョンが 3.10 以上であることを確認してください
- サブモジュール（lz4、snappy、tiff）が正しく配置されていることを確認してください

### 実行時エラー

- 入力/出力ディレクトリへのアクセス権限を確認してください
- ディスク容量が十分にあることを確認してください
- ファイル名パターンが正しいことを確認してください

### パフォーマンス問題

- 監視ディレクトリと出力ディレクトリは異なるディスクに配置することを推奨
- SSD の使用を推奨
